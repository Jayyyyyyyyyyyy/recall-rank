package com.wifi.recommend

import com.fasterxml.jackson.databind.{DeserializationFeature, ObjectMapper}
import com.fasterxml.jackson.module.scala.DefaultScalaModule
import com.fasterxml.jackson.module.scala.experimental.ScalaObjectMapper
import org.apache.spark.storage.StorageLevel
import org.apache.spark.{SparkConf, SparkContext}

object UserCooccurMatrix {

  def main(args: Array[String]): Unit = {
    if (args.length < 2) {
      Console.err.println("facet, input, output")
    }
    //var json = JSON.parseFull("{\"bait\": {}, \"topics\": {\"740\": {\"cs\": [5.9989, 2.235856, 1.791576, 0.8013], \"count_info\": [1, 1, 30617, 1750, 184257106, 4]}, \"115\": {\"cs\": [5.974, 2.231226, 1.787417, 0.8011], \"count_info\": [1, 1, 407764, 40029, 184257106, 4]}, \"865\": {\"cs\": [5.5067, 2.142182, 1.705966, 0.7964], \"count_info\": [1, 1, 5433619, 825246, 184257106, 4]}, \"370\": {\"cs\": [5.5427, 2.149158, 1.712482, 0.7968], \"count_info\": [1, 1, 4337124, 760184, 184257106, 4]}}, \"keywords\": {}, \"topics128\": {\"109\": {\"cs\": [8.0686, 1.915083, 2.08798, 1.0903], \"ck\": [2.0377, 0.8242, 0.7118, 0.8637], \"count_info\": [2, 2, 19232765, 3027573, 208332340, 5]}, \"42\": {\"cs\": [5.8727, 2.212221, 1.770314, 0.8002], \"count_info\": [2, 1, 3797026, 180632, 208332340, 5]}, \"74\": {\"cs\": [5.8633, 2.210448, 1.768713, 0.8002], \"count_info\": [1, 1, 1424285, 194293, 208332340, 5]}}, \"neg_source\": {}, \"neg_tags\": {}, \"topics256\": {\"103\": {\"cs\": [5.259, 2.093434, 1.659941, 0.7929], \"count_info\": [2, 1, 7393098, 1005162, 214001203, 6]}, \"180\": {\"cs\": [4.3245, 1.898349, 1.464297, 0.7714], \"count_info\": [1, 1, 16365362, 2763839, 214001203, 6]}, \"74\": {\"cs\": [5.9306, 2.223106, 1.780125, 0.8007], \"count_info\": [1, 1, 925405, 83429, 214001203, 6]}, \"225\": {\"cs\": [5.2213, 2.085924, 1.652746, 0.7923], \"count_info\": [1, 1, 5897673, 1063871, 214001203, 6]}, \"53\": {\"cs\": [5.9715, 2.230756, 1.786998, 0.8011], \"count_info\": [1, 1, 968519, 34012, 214001203, 6]}}, \"subcats\": {\"教育/小学\": {\"cs\": [4.725, 1.984312, 1.552868, 0.7826], \"count_info\": [1, 1, 7354892, 1772544, 131376071, 4]}, \"教育/学前教育\": {\"cs\": [5.2456, 2.090768, 1.65739, 0.7927], \"count_info\": [1, 1, 6250675, 944739, 131376071, 4]}, \"教育/其他\": {\"cs\": [4.2626, 1.884712, 1.449879, 0.7693], \"count_info\": [1, 1, 14548577, 2677464, 131376071, 4]}, \"科技/其他\": {\"cs\": [5.7347, 2.186076, 1.746535, 0.7989], \"count_info\": [2, 1, 6014580, 303872, 131376071, 4]}}, \"cats\": {\"科技\": {\"cs\": [5.5815, 2.15667, 1.719458, 0.7973], \"count_info\": [4, 1, 12964060, 581946, 116412260, 3]}, \"教育\": {\"cs\": [3.8638, 1.794385, 1.351651, 0.7533], \"count_info\": [1, 1, 23864305, 4290824, 116412260, 3]}, \"育儿\": {\"cs\": [3.7134, 1.75912, 1.311948, 0.7458], \"count_info\": [1, 1, 28645027, 4778868, 116412260, 3]}}, \"sick\": {}, \"topics64\": {\"42\": {\"cs\": [6.4078, 1.706639, 1.857516, 1.0884], \"ck\": [1.9651, 0.8093, 0.6755, 0.8347], \"count_info\": [2, 2, 32750971, 5749416, 200560166, 5]}, \"29\": {\"cs\": [5.365, 2.114437, 1.679896, 0.7945], \"count_info\": [2, 1, 10127439, 949507, 200560166, 5]}, \"41\": {\"cs\": [5.9187, 2.220864, 1.778117, 0.8006], \"count_info\": [1, 1, 3316956, 110218, 200560166, 5]}}, \"indepth\": {}, \"template\": {}, \"tags\": {\"大数据\": {\"cs\": [5.8239, 2.203003, 1.76197, 0.7998], \"count_info\": [1, 1, 46395, 1797, 1782533, 6]}, \"小雨\": {\"cs\": [5.2003, 2.081722, 1.648716, 0.792], \"count_info\": [1, 1, 802027, 171995, 33552485, 6]}, \"人工智能\": {\"cs\": [5.8715, 2.211991, 1.77011, 0.8002], \"count_info\": [1, 1, 493839, 8602, 11790199, 6]}, \"小学\": {\"cs\": [4.2644, 1.885122, 1.450301, 0.7693], \"count_info\": [1, 1, 5794884, 1377264, 101520503, 6]}, \"被子\": {\"cs\": [5.196, 2.080869, 1.647889, 0.7919], \"count_info\": [1, 1, 800544, 172642, 33472773, 6]}, \"马云\": {\"cs\": [5.1624, 2.074117, 1.641402, 0.7914], \"count_info\": [2, 1, 2530715, 267891, 49529798, 6]}}, \"dhid\": \"0003406e2e2f4d6792247be20d58390d\", \"content_type\": {}, \"demand\": {\"UNKNOWN\": {\"cs\": [3.1177, 1.611868, 1.137096, 0.7055], \"count_info\": [4, 1, 74140597, 8211667, 88825804, 2]}, \"LEISURE\": {\"ck\": [0.6671, 0.5775, -0.4048, 0.7009], \"count_info\": [12, 1, 477733839, 79546071, 88825804, 2]}}, \"date\": \"2017-08-22\", \"u_click\": 2, \"offending\": {\"1\": {\"ck\": [0.5223, 0.7227, -0.6495, 0.8987], \"count_info\": [5, 0, 205305711, 37547986, 88825804, 2]}}, \"dirty\": {}, \"title_type\": {}, \"topics512\": {\"300\": {\"cs\": [4.7876, 1.997419, 1.566029, 0.784], \"count_info\": [1, 1, 10245586, 2036004, 201001832, 5]}, \"399\": {\"cs\": [4.9811, 2.037382, 1.605651, 0.7881], \"count_info\": [1, 1, 9731113, 1644598, 201001832, 5]}, \"343\": {\"cs\": [3.8136, 1.782694, 1.338574, 0.7509], \"count_info\": [2, 1, 21811547, 4609515, 201001832, 5]}, \"498\": {\"cs\": [5.9896, 2.234128, 1.790025, 0.8012], \"count_info\": [1, 1, 378146, 13967, 201001832, 5]}, \"85\": {\"cs\": [5.9777, 2.231914, 1.788036, 0.8011], \"count_info\": [1, 1, 650629, 29956, 201001832, 5]}}}")
    //json=JSON.parseFull("{\"bait\": {}, \"topics\": {\"743\": {\"cs\": [5.3648, 2.114394, 1.679859, 0.794487], \"count_info\": [1, 1, 6463258, 1085796, 137555621, 3]}, \"415\": {\"cs\": [4.7669, 2.060875, 1.561696, 0.757783], \"count_info\": [1.9207999999999998, 0.9223681599999999, 28481720.13337728, 2620464.56362656, 204550694.30779088, 2.7671044799999995]}, \"947\": {\"cs\": [5.8716, 2.230681, 1.770127, 0.793537], \"count_info\": [0.98, 0.98, 376580.68, 46351.06, 140890959.3, 2.94]}, \"865\": {\"cs\": [5.2866, 2.098932, 1.665175, 0.793344], \"count_info\": [2, 1, 6240560, 1237463, 137555621, 3]}, \"859\": {\"cs\": [5.2484, 2.162448, 1.657923, 0.766688], \"count_info\": [0.9603999999999999, 0.9223681599999999, 10656289.422801118, 1023808.37279952, 204550694.30779088, 2.7671044799999995]}, \"798\": {\"cs\": [5.2715, 2.113613, 1.662315, 0.78648], \"count_info\": [1.96, 0.98, 9147327.84, 1142743.7, 140890959.3, 2.94]}, \"525\": {\"cs\": [5.8181, 2.201908, 1.760974, 0.799749], \"count_info\": [1, 1, 1301029, 286742, 137555621, 3]}, \"506\": {\"cs\": [4.8158, 2.020192, 1.571902, 0.778095], \"count_info\": [1.9404, 0.98, 32874394.5292, 3674772.9144, 239939068.4768, 2.94]}, \"478\": {\"cs\": [5.1184, 2.13549, 1.632842, 0.764622], \"count_info\": [2.861992, 0.9223681599999999, 20591725.59143168, 2158737.10966704, 309779680.4397669, 2.7671044799999995]}}, \"keywords\": {\"青椒\": {\"cs\": [5.1962, 2.151659, 1.647928, 0.765887], \"count_info\": [0.0, 0.9223681599999999, 1968505.21391776, 168084.99453311996, 58139725.38846415, 5.534208959999999]}, \"道菜\": {\"cs\": [4.9656, 2.10338, 1.602534, 0.761885], \"count_info\": [0.0, 0.9223681599999999, 5514765.4391872, 458827.42935119994, 97553926.24381262, 5.534208959999999]}, \"造型\": {\"cs\": [5.4499, 2.149079, 1.695597, 0.788988], \"count_info\": [0.98, 0.98, 2923814.32, 325922.52, 116016694.36, 5.88]}, \"鸡蛋\": {\"cs\": [4.981, 2.106632, 1.605631, 0.762179], \"count_info\": [1.9207999999999998, 0.9223681599999999, 9799999.930224, 1069493.34421216, 233651167.39424095, 5.534208959999999]}, \"古装\": {\"cs\": [5.4493, 2.14897, 1.695487, 0.788977], \"count_info\": [0.98, 0.98, 2048274.48, 255291.96, 90753414.5, 5.88]}, \"养眼\": {\"cs\": [5.6503, 2.188246, 1.731709, 0.791368], \"count_info\": [0.98, 0.98, 421388.24, 52841.6, 35159743.22, 5.88]}, \"家常菜\": {\"cs\": [5.1371, 2.139389, 1.636489, 0.764933], \"count_info\": [0.0, 0.9223681599999999, 2387801.7886676798, 224806.02453231995, 67306566.05060416, 5.534208959999999]}, \"林心如\": {\"cs\": [5.4623, 2.151528, 1.69787, 0.789146], \"count_info\": [0.98, 0.98, 1989451.94, 243143.88, 89210194.78, 5.88]}, \"口感\": {\"cs\": [5.2565, 2.164127, 1.659465, 0.766806], \"count_info\": [0.0, 0.9223681599999999, 1877403.8331227198, 148982.74993951997, 60992426.55608032, 5.534208959999999]}, \"丫头\": {\"cs\": [5.654, 2.188955, 1.732363, 0.791411], \"count_info\": [0.98, 0.98, 399263.76, 48944.14, 33072375.56, 5.88]}, \"剧中\": {\"cs\": [5.4697, 2.15299, 1.699224, 0.789239], \"count_info\": [0.98, 0.98, 1493474.92, 192081.96, 71789655.98, 5.88]}, \"加点\": {\"cs\": [5.2372, 2.160131, 1.655787, 0.766522], \"count_info\": [0.0, 0.9223681599999999, 1715063.34749008, 134567.98033503996, 52046803.906330235, 5.534208959999999]}}, \"topics128\": {\"25\": {\"cs\": [5.5738, 2.173378, 1.718077, 0.79051], \"count_info\": [0.98, 0.98, 5410742.68, 694062.46, 174342477.26, 2.94]}, \"85\": {\"cs\": [4.3681, 1.924002, 1.474328, 0.766282], \"count_info\": [1.96, 0.98, 31960344.08, 4159322.86, 174342477.26, 2.94]}, \"109\": {\"cs\": [3.9613, 1.816877, 1.376572, 0.757658], \"count_info\": [2.98, 1.0, 37866785.54, 7016729.46, 336744205.26, 4.9399999999999995]}, \"64\": {\"cs\": [5.1564, 2.090414, 1.640239, 0.784648], \"count_info\": [0.98, 0.98, 13595201.9, 1710324.42, 174342477.26, 2.94]}, \"61\": {\"cs\": [4.1131, 1.851373, 1.414177, 0.763853], \"count_info\": [1, 1, 41862905, 7450257, 162401728, 2]}}, \"neg_source\": {}, \"neg_tags\": {}, \"topics256\": {\"92\": {\"cs\": [5.6699, 2.173691, 1.735171, 0.79826], \"count_info\": [1, 1, 4203976, 631885, 162811299, 3]}, \"180\": {\"cs\": [3.8191, 1.783973, 1.340015, 0.751141], \"count_info\": [2.98, 1.0, 34045086.42, 6517739.22, 338976732.08, 5.9399999999999995]}, \"62\": {\"cs\": [5.0672, 2.054915, 1.622788, 0.789711], \"count_info\": [1, 1, 11270103, 1998061, 162811299, 3]}, \"238\": {\"cs\": [5.1137, 2.081741, 1.631923, 0.783922], \"count_info\": [0.98, 0.98, 14599092.34, 1842696.94, 176165433.07999998, 2.94]}, \"177\": {\"cs\": [4.175, 1.880984, 1.429114, 0.759769], \"count_info\": [0.98, 0.98, 30633554.419999998, 4951648.9399999995, 176165433.07999998, 2.94]}, \"101\": {\"cs\": [3.6209, 1.751724, 1.286723, 0.734546], \"count_info\": [0.98, 0.98, 40950636.72, 7543241.3, 176165433.07999998, 2.94]}}, \"subcats\": {\"娱乐/电视剧\": {\"cs\": [5.5894, 2.120213, 1.720872, 0.81165], \"count_info\": [0.98, 0.98, 6070513.96, 768899.1799999999, 67800712.0, 0.98]}, \"美食/其他\": {\"cs\": [5.2938, 2.107968, 1.666536, 0.790589], \"count_info\": [2.861992, 0.9223681599999999, 17076508.457572475, 2049238.16779024, 157284114.35217378, 0.9223681599999999]}, \"教育/学前教育\": {\"cs\": [5.5664, 2.153764, 1.716749, 0.797092], \"count_info\": [1, 1, 4352483, 732990, 94107525, 2]}, \"教育/其他\": {\"cs\": [5.5578, 2.152086, 1.715202, 0.796995], \"count_info\": [1, 1, 5439494, 748814, 94107525, 2]}}, \"cats\": {\"娱乐\": {\"cs\": [4.4293, 1.729885, 1.488242, 0.860313], \"count_info\": [2.9204, 0.98, 76321551.6532, 8250928.464799999, 121763427.002, 0.98]}, \"教育\": {\"cs\": [4.7698, 1.993704, 1.562304, 0.783619], \"count_info\": [1, 1, 14659247, 2493209, 96670623, 2]}, \"育儿\": {\"cs\": [3.1946, 1.631614, 1.161462, 0.711848], \"count_info\": [1.98, 1.0, 50052114.58, 9741134.58, 165278786.4, 2.98]}, \"美食\": {\"cs\": [4.6134, 1.856266, 1.528965, 0.823678], \"count_info\": [7.663992, 0.9223681599999999, 75676662.87876463, 7480244.970528959, 159394735.79025024, 0.9223681599999999]}}, \"sick\": {}, \"topics64\": {\"28\": {\"cs\": [5.229, 1.992636, 1.65422, 0.830167], \"count_info\": [1.96, 0.98, 33481986.16, 4343601.08, 165865449.82, 0.98]}, \"42\": {\"cs\": [4.1137, 1.851516, 1.414323, 0.763873], \"count_info\": [2.98, 1.0, 55153334.3, 9736121.14, 316377705.82, 2.98]}}, \"indepth\": {}, \"template\": {}, \"tags\": {\"舞蹈\": {\"cs\": [5.2969, 2.100964, 1.667122, 0.793503], \"count_info\": [1, 1, 1347971, 291800, 32972719, 3]}, \"健身\": {\"cs\": [5.2281, 2.087286, 1.654048, 0.792439], \"count_info\": [1, 1, 3605743, 637505, 64769102, 3]}, \"美景\": {\"cs\": [5.5831, 2.175193, 1.719744, 0.790617], \"count_info\": [0.98, 0.98, 761744.2, 87327.8, 22618628.34, 2.94]}, \"鸡蛋\": {\"cs\": [5.003, 2.111291, 1.610038, 0.762585], \"count_info\": [0.9603999999999999, 0.9223681599999999, 5367049.37348496, 554947.34654016, 63093092.70903296, 2.7671044799999995]}, \"王艳\": {\"cs\": [5.6033, 2.179121, 1.723356, 0.790849], \"count_info\": [0.98, 0.98, 634252.08, 73313.8, 20353980.64, 2.94]}, \"妈妈\": {\"cs\": [4.6349, 1.965305, 1.533615, 0.780344], \"count_info\": [1, 1, 10034033, 1987691, 101232533, 3]}, \"林心如\": {\"cs\": [5.5231, 2.163461, 1.708939, 0.78991], \"count_info\": [0.98, 0.98, 798295.26, 97057.24, 20905441.34, 2.94]}, \"美食\": {\"cs\": [3.8335, 1.848114, 1.343778, 0.727108], \"count_info\": [0.0, 0.9223681599999999, 18964559.931252316, 2491889.19078736, 74318396.81213807, 2.7671044799999995]}, \"果蔬\": {\"cs\": [4.5271, 2.008369, 1.510082, 0.751894], \"count_info\": [0.9603999999999999, 0.9223681599999999, 17958792.025911517, 1969021.6847683198, 113697833.42329776, 2.7671044799999995]}}, \"dhid\": \"00007aff5a3b46278d86aa3e58600b11\", \"content_type\": {}, \"demand\": {\"UNKNOWN\": {\"cs\": [3.1769, 1.627088, 1.155906, 0.710414], \"count_info\": [1.98, 1.0, 81463789.75999999, 12015515.82, 133861141.92, 1.98]}}, \"date\": \"2017-08-14\", \"u_click\": 1, \"offending\": {}, \"dirty\": {}, \"title_type\": {}, \"topics512\": {\"335\": {\"cs\": [4.8281, 2.022766, 1.574453, 0.778366], \"count_info\": [0.98, 0.98, 18638350.5, 2435011.88, 161221657.1, 2.94]}, \"311\": {\"cs\": [5.7064, 2.19907, 1.741588, 0.791966], \"count_info\": [0.98, 0.98, 1739909.64, 372145.2, 161221657.1, 2.94]}, \"310\": {\"cs\": [3.6873, 1.767721, 1.304894, 0.738179], \"count_info\": [0.98, 0.98, 34687616.46, 6581383.06, 161221657.1, 2.94]}, \"399\": {\"cs\": [5.1595, 2.073543, 1.64084, 0.791322], \"count_info\": [1, 1, 9356581, 1619230, 149096904, 3]}, \"419\": {\"cs\": [5.8218, 2.202618, 1.761609, 0.79978], \"count_info\": [1, 1, 1509239, 304196, 149096904, 3]}, \"254\": {\"cs\": [4.096, 1.847513, 1.410011, 0.763194], \"count_info\": [2.98, 1.0, 25445503.52, 4857012.38, 310318561.1, 5.9399999999999995]}}}")
    //json = JSON.parseFull("{\"bait\": {}, \"topics\": {\"211\": {\"cs\": [5.8599, 2.184438, 1.768133, 0.809422], \"count_info\": [1, 1, 4628418, 655186, 136984374, 1]}}, \"keywords\": {}, \"topics128\": {\"109\": {\"cs\": [4.8673, 2.013981, 1.582539, 0.785777], \"count_info\": [2.9208, 1.0, 39534758.0744, 7172167.1632, 308208898.4916, 2.0]}}, \"neg_source\": {}, \"neg_tags\": {}, \"topics256\": {\"180\": {\"cs\": [5.0934, 2.060211, 1.627946, 0.790184], \"count_info\": [1.9604, 1.0, 30069050.0152, 5566942.8936, 312742481.34080005, 2.0]}, \"170\": {\"cs\": [5.9498, 2.226694, 1.783358, 0.800899], \"count_info\": [1, 1, 914736, 131713, 156100231, 2]}}, \"subcats\": {\"教育/小学\": {\"cs\": [5.8285, 2.173058, 1.76276, 0.811189], \"count_info\": [1, 1, 3806025, 559948, 95175956, 1]}, \"健康/其他\": {\"ck\": [0.5777, 0.760064, -0.548701, 0.721914], \"count_info\": [4.76592832, 0.0, 89189541.7888496, 13680151.306110239, 255477829.36200574, 1.0]}}, \"cats\": {\"教育\": {\"cs\": [5.2778, 1.981329, 1.663509, 0.839593], \"count_info\": [1, 1, 16208875, 2572943, 94016391, 1]}}, \"sick\": {\"1\": {\"ck\": [0.5523, 0.743166, -0.593664, 0.798831], \"count_info\": [4.822392, 0.0, 220650044.83630398, 37090385.085208, 175951673.151864, 1.0]}, \"0\": {\"ck\": [0.6517, 0.570815, -0.428171, 0.750104], \"count_info\": [15.294248640000001, 1.0, 1674226986.8916068, 226497913.6781717, 282953906.0320058, 1.0]}}, \"topics64\": {\"42\": {\"cs\": [4.3326, 1.900142, 1.466168, 0.771609], \"count_info\": [2.9208, 1.0, 62067809.8028, 11234579.2124, 291933109.28639996, 2.0]}, \"49\": {\"cs\": [4.1229, 1.853582, 1.416557, 0.764227], \"count_info\": [2.9604, 1.0, 90760450.1976, 13291121.7292, 291933109.28639996, 2.0]}}, \"indepth\": {}, \"template\": {}, \"tags\": {\"教师\": {\"cs\": [5.4232, 2.125878, 1.690686, 0.795288], \"count_info\": [1, 1, 2324304, 337447, 47594041, 3]}, \"小学生\": {\"cs\": [5.4121, 2.1237, 1.688637, 0.795139], \"count_info\": [1, 1, 1708569, 255304, 35255859, 3]}, \"思维\": {\"cs\": [5.4994, 2.140756, 1.704639, 0.796279], \"count_info\": [1, 1, 689459, 121590, 20036195, 3]}}, \"dhid\": \"000002eee8c24ef3bda848f12aa83aab\", \"content_type\": {}, \"demand\": {\"UNKNOWN\": {\"cs\": [4.2012, 1.64119, 1.43537, 0.874591], \"count_info\": [4.841991999999999, 1.0, 144887340.130032, 19928687.566064, 232725320.989424, 1.0]}, \"LEISURE\": {\"ck\": [0.315, 0.561283, -1.155183, 2.058111], \"count_info\": [15.27464864, 0.0, 1814394511.1560023, 258263555.21908465, 282796411.3746661, 1.0]}}, \"date\": \"2017-08-11\", \"u_click\": 1, \"offending\": {\"1\": {\"ck\": [0.4025, 0.634403, -0.91006, 1.434514], \"count_info\": [8.722792000000002, 0.0, 561254980.156368, 95529200.46970399, 232725317.989424, 1.0]}}, \"dirty\": {\"1\": {\"ck\": [0.5197, 0.720932, -0.654504, 0.907858], \"count_info\": [4.8808, 0.0, 328599357.254, 62210231.3592, 181348955.23000002, 1.0]}, \"0\": {\"ck\": [0.6668, 0.577421, -0.405265, 0.701854], \"count_info\": [15.23584064, 1.0, 1432944350.998745, 188032945.57611376, 282951894.0320058, 1.0]}}, \"title_type\": {}, \"topics512\": {\"100\": {\"cs\": [5.897, 2.216796, 1.774444, 0.800454], \"count_info\": [1, 1, 1792937, 255314, 146207789, 2]}, \"454\": {\"cs\": [5.7498, 2.188952, 1.749165, 0.799088], \"count_info\": [1, 1, 3097433, 636178, 146207789, 2]}}}")

    val Array(facet, input, output) = args
    val conf = new SparkConf().setAppName("CooccurMatrix")
    conf.set("spark.hadoop.io.compression.codecs", "com.hadoop.compression.lzo.LzoCodec,com.hadoop.compression.lzo.LzopCodec")

    val sc = new SparkContext(conf)

    val userLikes = sc.textFile(input).coalesce(500).mapPartitions { lines =>
      val mapper = new ObjectMapper() with ScalaObjectMapper
      mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false)
      mapper.registerModule(DefaultScalaModule)
      lines.map { l =>
        val userId = l.split("\t")(0)

        val views = try {
          val json = mapper.readValue[Map[String, Object]](l.split("\t")(1))
          val facetItems = json(facet).asInstanceOf[Map[String, Map[String, List[Double]]]]
          facetItems.map { case (fct, likes) =>
            if (likes.contains("cs")) {
              (fct, likes("cs").head)
            } else
              ("NONE", 0.0)
          }.filter(_._1 != "NONE")
        } catch {
          case _: Throwable => Map("NONE" -> 0.0)
        }
        (userId, views)
      }.filter(_._2.size > 1)
    }.persist(StorageLevel.DISK_ONLY)
    userLikes.map(x => x._1 + "\t" + x._2.map(x => x._1 + ":" + x._2).reduce(_ + " " + _))
      .saveAsTextFile(output + "/likes")

    val vocabrdd = userLikes.flatMap(_._2.keys).distinct().zipWithIndex().mapValues(_.toInt).cache()
    val vocab = vocabrdd.collectAsMap()
    vocabrdd.saveAsTextFile(output + "/vocab")

    userLikes.flatMap { likes =>
      val likeSeq = likes._2.take(50).toArray.map(i => (vocab(i._1), i._2)).sortWith(_._1 < _._1)
      for (i <- likeSeq.indices; j <- likeSeq.indices.drop(i + 1)) yield {
        ((likeSeq(i)._1, likeSeq(j)._1), math.min(likeSeq(i)._2.asInstanceOf[Double], likeSeq(j)._2.asInstanceOf[Double]))
        //((likeSeq(i)._1, likeSeq(j)._1), 1)

      }
    }.flatMap {
      case ((i, j), sim) =>
        Seq(((i, j), sim), ((j, i), sim))
    }.reduceByKey(_ + _).map { case ((i, j), c) =>
      i + " " + j + " " + math.log1p(c)
    }.saveAsTextFile(output + "/cooccur")
  }

}
